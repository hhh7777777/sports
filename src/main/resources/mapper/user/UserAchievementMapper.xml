<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongyuting.sports.mapper.UserAchievementMapper">

    <resultMap id="userAchievementResultMap" type="UserAchievement">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="badgeId" column="badge_id"/>
        <result property="achieveTime" column="achieve_time"/>
        <result property="progress" column="progress"/>
    </resultMap>

    <resultMap id="userBadgeResultMap" type="UserBadge">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="badgeId" column="badge_id"/>
        <result property="achieveTime" column="achieve_time"/>
        <result property="progress" column="progress"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="selectByUserId" resultMap="userAchievementResultMap">
        SELECT * FROM user_achievement
        WHERE user_id = #{userId}
    </select>

    <select id="selectRecentlyAchievedBadges" resultMap="userBadgeResultMap">
        SELECT * FROM user_achievement WHERE user_id = #{userId} 
        ORDER BY achieve_time DESC LIMIT #{limit}
    </select>

    <select id="countUsersWithBadge" resultType="int">
        SELECT COUNT(DISTINCT user_id) FROM user_achievement WHERE badge_id = #{badgeId} AND progress >= 100
    </select>

    <select id="countAchievementsByUserAndDate" resultType="int">
        SELECT COUNT(*) FROM user_achievement 
        WHERE user_id = #{userId} 
        AND DATE(achieve_time) BETWEEN #{startDate} AND #{endDate}
    </select>

    <insert id="insertUserAchievement" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_achievement
            (user_id, badge_id, progress)
        VALUES
            (#{userId}, #{badgeId}, #{progress})
    </insert>

    <update id="updateUserAchievement">
        UPDATE user_achievement SET
            progress = #{progress},
            update_time = #{updateTime}
        WHERE user_id = #{userId} AND badge_id = #{badgeId}
    </update>

    <select id="selectUserAchievement" resultMap="userAchievementResultMap">
        SELECT * FROM user_achievement
        WHERE user_id = #{userId} AND badge_id = #{badgeId}
    </select>

    <select id="existsByUserIdAndBadgeId" resultType="boolean">
        SELECT COUNT(*) > 0 FROM user_achievement
        WHERE user_id = #{userId} AND badge_id = #{badgeId}
    </select>

    <select id="selectByBadgeId" resultMap="userAchievementResultMap">
        SELECT * FROM user_achievement
        WHERE badge_id = #{badgeId}
        ORDER BY achieve_time DESC
    </select>

    <select id="selectRecentlyByUserId" resultMap="userAchievementResultMap">
        SELECT ua.* FROM user_achievement ua
                             JOIN achievement_badge ab ON ua.badge_id = ab.badge_id
        WHERE ua.user_id = #{userId}
        ORDER BY ua.achieve_time DESC
        LIMIT 5
    </select>

    <select id="countAchievementsByUserId" resultType="int">
        SELECT COUNT(*) FROM user_achievement
        WHERE user_id = #{userId}
    </select>

    <select id="sumPointsByUserId" resultType="int">
        SELECT COALESCE(SUM(ab.reward_points), 0)
        FROM user_achievement ua
                 JOIN achievement_badge ab ON ua.badge_id = ab.badge_id
        WHERE ua.user_id = #{userId}
    </select>

    <select id="selectUserBadgesByUserId" resultMap="userBadgeResultMap">
        SELECT * FROM user_achievement WHERE user_id = #{userId} ORDER BY achieve_time DESC
    </select>

    <insert id="insertUserBadge" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_achievement (user_id, badge_id, achieve_time, progress, update_time)
        VALUES (#{userId}, #{badgeId}, #{achieveTime}, #{progress}, #{updateTime})
    </insert>

    <select id="selectUserBadge" resultMap="userBadgeResultMap">
        SELECT * FROM user_achievement 
        WHERE user_id = #{userId} AND badge_id = #{badgeId}
    </select>

</mapper>