<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hongyuting.sports.mapper.UserMapper">

    <resultMap id="userResultMap" type="com.hongyuting.sports.entity.User">
        <id property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="email" column="email"/>
        <result property="salt" column="salt"/>
        <result property="nickname" column="nickname"/>
        <result property="birthday" column="birthday"/>
        <result property="gender" column="gender"/>
        <result property="height" column="height"/>
        <result property="weight" column="weight"/>
        <result property="avatar" column="avatar"/>
        <result property="wxOpenid" column="wx_openid"/>
        <result property="registerTime" column="register_time"/>
        <result property="userStatus" column="user_status"/>
        <result property="lastLoginTime" column="last_login_time"/>
    </resultMap>

    <!-- 继承BaseMapper的通用方法 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO user (username, password, email, salt, nickname, birthday, gender, height, weight, avatar, wx_openid, register_time, user_status)
        VALUES (#{username}, #{password}, #{email}, #{salt}, #{nickname}, #{birthday}, #{gender}, #{height}, #{weight}, #{avatar}, #{wxOpenid}, #{registerTime}, #{userStatus})
    </insert>

    <delete id="deleteById">
        DELETE FROM user WHERE user_id = #{userId}
    </delete>

    <update id="updateById">
        UPDATE user
        <set>
            <if test="username != null and username != ''">username = #{username},</if>
            <if test="password != null and password != ''">password = #{password},</if>
            <if test="email != null and email != ''">email = #{email},</if>
            <if test="salt != null and salt != ''">salt = #{salt},</if>
            <if test="nickname != null and nickname != ''">nickname = #{nickname},</if>
            <if test="birthday != null">birthday = #{birthday},</if>
            <if test="gender != null and gender != ''">gender = #{gender},</if>
            <if test="height != null">height = #{height},</if>
            <if test="weight != null">weight = #{weight},</if>
            <if test="avatar != null and avatar != ''">avatar = #{avatar},</if>
            <if test="wxOpenid != null and wxOpenid != ''">wx_openid = #{wxOpenid},</if>
            <if test="registerTime != null">register_time = #{registerTime},</if>
            <if test="userStatus != null">user_status = #{userStatus},</if>
            <if test="lastLoginTime != null">last_login_time = #{lastLoginTime},</if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <select id="selectById" resultMap="userResultMap">
        SELECT * FROM user WHERE user_id = #{userId}
    </select>

    <select id="selectAll" resultMap="userResultMap">
        SELECT * FROM user ORDER BY register_time DESC
    </select>

    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*) FROM user
    </select>

    <!-- 特有方法 -->
    <select id="selectByUsername" resultMap="userResultMap">
        SELECT * FROM user WHERE username = #{username}
    </select>

    <select id="searchUsers" resultMap="userResultMap">
        SELECT * FROM user
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="email != null and email != ''">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="status != null">
                AND user_status = #{status}
            </if>
        </where>
        ORDER BY register_time DESC
    </select>

    <select id="countByUsername" resultType="int">
        SELECT COUNT(*) FROM user WHERE username = #{username}
    </select>

    <select id="countByEmail" resultType="int">
        SELECT COUNT(*) FROM user WHERE email = #{email}
    </select>

    <update id="updateUserAvatar">
        UPDATE user SET avatar = #{avatar} WHERE user_id = #{userId}
    </update>

    <select id="selectUserCountByMonth" resultType="int">
        SELECT COUNT(*) FROM user
        WHERE YEAR(register_time) = #{year} AND MONTH(register_time) = #{month}
    </select>

    <select id="selectTotalDurationByUserAndDate" resultType="int">
        SELECT COALESCE(SUM(duration), 0)
        FROM behavior_record
        WHERE user_id = #{userId}
          AND record_date BETWEEN #{startDate} AND #{endDate}
    </select>

    <select id="selectBehaviorTypeDistribution" resultType="map">
        SELECT
            bt.type_name as typeName,
            COUNT(br.record_id) as recordCount,
            COALESCE(SUM(br.duration), 0) as totalDuration
        FROM behavior_type bt
                 LEFT JOIN behavior_record br ON bt.type_id = br.type_id
            AND br.user_id = #{userId}
            AND br.record_date BETWEEN #{startDate} AND #{endDate}
        WHERE bt.status = 1
        GROUP BY bt.type_id, bt.type_name
    </select>

    <select id="countBehaviorRecordsByTypeAndDate" resultType="int">
        SELECT COUNT(*) FROM behavior_record br
                                 JOIN behavior_type bt ON br.type_id = bt.type_id
        WHERE br.user_id = #{userId}
          AND bt.type_name = #{typeName}
          AND br.record_date BETWEEN #{startDate} AND #{endDate}
    </select>

    <select id="selectExerciseDatesByUser" resultType="java.time.LocalDate">
        SELECT DISTINCT record_date FROM behavior_record
        WHERE user_id = #{userId}
        ORDER BY record_date DESC
    </select>
</mapper>